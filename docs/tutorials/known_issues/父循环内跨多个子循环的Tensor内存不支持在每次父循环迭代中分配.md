# 父循环内跨多个子循环的Tensor内存不支持在每次父循环迭代中分配

## 问题现象描述

两层或者两层以上循环嵌套下，在父循环中定义了一个 tensor，在一个子循环中写入该 tensor，在另一个子循环中使用该 tensor 时，存在精度错误。

## 可能原因

在该GM上的Tensor，在父循环的多次迭代中，每次迭代分配的内存地址相同，导致不同迭代本应使用不同的临时内存来保存数据，但实际上使用了相同的地址。由于不同循环迭代实际上是并行执行的，因此当多个迭代同时进行时，后执行的迭代会覆盖前一次迭代的临时内存，从而导致精度问题。

## 处理步骤

在后一个子循环中添加submit\_before\_loop = True，以在启动该子循环前下发任务，强制多次迭代串行运行，从而避免并行执行时因内存覆盖和冲突导致的精度问题。

```python
for outer in pypto.loop(...): # 父循环，执行至少两次，如果只执行一次，不存在多次并行覆盖的问题
    t = pypto.Tensor(...)  # 定义一个临时tensor
    for inner0 in pypto.loop(...): # 第一个子循环，对临时tensor t赋值
        ...
        t[...] = ... 
    # 添加 submit_before_loop，确保父循环多次迭代不在同一个并行执行块中
    for inner1 in pypto.loop(..., submit_before_loop=True): # 第二个子循环，使用了临时 tensor t，                                   
        x[:] = t[:] + t[:]
```

